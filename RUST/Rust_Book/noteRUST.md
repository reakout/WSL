# `RUST`æƒå¨æŒ‡å—è¯»ä¹¦ç¬”è®°

[TOC]

## Char3 é€šç”¨ç¼–ç¨‹æ¦‚å¿µ

### å˜é‡ä¸å¯å˜æ€§

#### å˜é‡

ç”¨letå£°æ˜çš„å˜é‡é»˜è®¤æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚ä»¥ä¸‹ä¼šæŠ¥é”™

```rust
fn main() {
    let x = 5;
    println!("The value of x is: {}", x);
    x = 6;
    println!("The value of x is: {}", x);
}
```

å¦‚æœæƒ³è¦æ”¹å˜å€¼çš„è¯ï¼Œéœ€è¦å£°æ˜æ—¶åŠ ä¸Š`mut`

`let mut x = 5;`

#### å¸¸é‡

`const`å…³é”®å­—ï¼Œä¸å…è®¸ä½¿ç”¨`mut`ä¹Ÿä¸èƒ½ä¿®æ”¹å€¼ï¼Œåªèƒ½è®¾ç½®ä¸º**å¸¸é‡è¡¨è¾¾å¼**ï¼Œä¸”**ç±»å‹å¿…é¡»æ³¨æ˜**ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨å‡½æ•°è°ƒç”¨ç»“æœæˆ–è€…è¿è¡Œæ—¶ç»“æœ

å¸¸é‡å‘½ååº”è¯¥ç”¨å…¨å¤§å†™åŠ ä¸‹åˆ’çº¿ï¼Œå¦‚ä¸‹:

`const THREE_HOURS_IN_SECONDS: u32 = 60 * 60 * 3;`

#### é®è”½

å¯ä»¥ç”¨`let`é‡å¤ä½¿ç”¨ç›¸åŒçš„å˜é‡åæ¥é®è”½å˜é‡ï¼Œå¦‚

```rust
fn main() {
    let x = 5;

    let x = x + 1;

    {
        let x = x * 2;
        println!("The value of x in the inner scope is: {}", x);
    }

    println!("The value of x is: {}", x);
}
```

å¤–å±‚ä½œç”¨åŸŸé‡Œé®è”½ä¸€æ¬¡ï¼Œå†…å±‚ä½œç”¨åŸŸé‡Œé®è”½ä¸€æ¬¡ï¼Œä½†ä¼ ä¸å‡ºæ¥ï¼Œæ‰€ä»¥ä¸¤æ¬¡è¾“å‡ºç»“æœåº”è¯¥æ˜¯12å’Œ6

é®è”½å¯ä»¥å®Œæˆä¸€äº›å€¼çš„è½¬æ¢ï¼Œä½†å®Œæˆä¹‹åè¿˜æ˜¯ä¸å¯å˜çš„

ä¸`mut`çš„åŒºåˆ«ï¼Œç”¨`let`æœ¬è´¨æ˜¯å†åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å˜é‡ï¼Œä½†æ˜¯é‡å¤ä½¿ç”¨äº†ç›¸åŒçš„åç§°ï¼Œå› æ­¤ç”¨`let`é®è”½å¯ä»¥åŒåæ¢ç±»å‹ï¼Œä½†`mut`ä¸å…è®¸æ›´æ”¹ç±»å‹ï¼Œå¦‚

```rust
fn main() {
    let spaces = "   ";
    let spaces = spaces.len();
}
```

```rust
fn main() {
    let mut spaces = "   ";
    spaces = spaces.len();
}
```

ç¬¬ä¸€ä¸ªokç¬¬äºŒä¸ªæŠ¥é”™ã€‚

### æ•°æ®ç±»å‹

`rust`æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œå³éœ€è¦åœ¨ç¼–è¯‘å™¨è€Œéè¿è¡Œæ—¶å¾—åˆ°æ‰€æœ‰çš„å˜é‡ç±»å‹

#### æ ‡é‡ç±»å‹

è¡¨ç¤ºå•ä¸ªå€¼çš„ç±»å‹ï¼ˆscalarï¼‰ï¼Œåœ¨`rust`ä¸­æœ‰æ•´å‹ã€æµ®ç‚¹ã€å¸ƒå°”å’Œå­—ç¬¦å››ç§

 ##### æ•´å‹

| é•¿åº¦   | æœ‰ç¬¦å·ç±»å‹ | æ— ç¬¦å·ç±»å‹ |
| ------ | ---------- | ---------- |
| 8 ä½   | `i8`       | `u8`       |
| 16 ä½  | `i16`      | `u16`      |
| 32 ä½  | `i32`      | `u32`      |
| 64 ä½  | `i64`      | `u64`      |
| 128 ä½ | `i128`     | `u128`     |
| arch   | `isize`    | `usize`    |

`isize`å’Œ`usize`å–å†³äºç³»ç»Ÿæ¶æ„ï¼Œ64ä½åˆ™æ˜¯64ä½ï¼Œ32ä½åˆ™32ä½

å¯èƒ½å±äºå¤šä¸ªæ•°å­—ç±»å‹çš„æ•°å­—å­—é¢å€¼å…è®¸ä½¿ç”¨ç±»å‹åç¼€æŒ‡å®šç±»å‹ï¼Œå¦‚`58u8`ã€‚æ•°å­—å­—é¢å€¼è¿˜å¯ä»¥ç”¨`_`ä½œä¸ºä¸å½±å“å¤§å°å’Œæ­£ç¡®æ€§çš„å¯è§†åˆ†å‰²ç¬¦ï¼Œå¦‚`1_000`

ä¸åŒè¿›åˆ¶è¿˜å¯ä»¥ç›´æ¥ç”¨äºå­—é¢é‡èµ‹å€¼

| æ•°å­—å­—é¢é‡         | ç¤ºä¾‹          |
| ------------------ | ------------- |
| åè¿›åˆ¶             | `98_222`      |
| åå…­è¿›åˆ¶           | `0xff`        |
| å…«è¿›åˆ¶             | `0o77`        |
| äºŒè¿›åˆ¶             | `0b1111_0000` |
| å­—èŠ‚ (ä»…é™äº `u8`) | `b'A'`        |

**æ•´å½¢é»˜è®¤æ˜¯`i32`**

è¶…å‡ºäº†è¡¨ç¤ºèŒƒå›´æ—¶ä¼šå‘ç”Ÿæ•´å‹æº¢å‡ºï¼Œåœ¨debugç‰ˆæœ¬ä¼šæ£€æŸ¥æ•´å‹æº¢å‡ºï¼ˆhowï¼Ÿï¼Ÿè¿™éœ€è¦è¿è¡Œæ—¶è¿›è¡Œå•Šï¼‰å¦‚æœå‘ç°å­˜åœ¨ï¼Œåˆ™ä¼šæŠ¥panicé€€å‡ºï¼Œpanicå®é™…ä¸Šå°±æ˜¯è¿è¡Œæ—¶çš„æ“ä½œã€‚åœ¨releaseç‰ˆæœ¬ä¸ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæº¢å‡ºä¼šè¿›è¡Œtwo's complement srappingäºŒè¿›åˆ¶è¡¥ç åŒ…è£¹ï¼ˆæ¯”å¦‚255ä¸Šé™æ—¶å¯¹åº”256ä¼šæº¢å‡ºæˆ0ï¼Œç±»ä¼¼ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼‰

##### æµ®ç‚¹ç±»å‹

`rust`ä¸­çš„æµ®ç‚¹ç±»å‹æœ‰`f32`å’Œ`f64` ä¸¤ç±»ï¼Œé»˜è®¤ä¸º`f64`ï¼Œå› ä¸ºé€Ÿåº¦ä¸`f32`å‡ ä¹ç›¸åŒï¼Œä½†ç²¾åº¦æ›´é«˜ï¼Œæ‰€æœ‰æµ®ç‚¹æ•°éƒ½æœ‰ç¬¦å·

é‡‡ç”¨`IEEE-754`æ ‡å‡†ï¼Œ`f32`æ˜¯å•ç²¾åº¦æµ®ç‚¹å‹`f64`æ˜¯åŒç²¾åº¦æµ®ç‚¹å‹

##### æ•°å­—è¿ç®—

æ”¯æŒåŠ å‡ä¹˜é™¤å–æ¨¡ï¼Œä¸”æ•´æ•°é™¤æ³•å‘ä¸‹å–æ•´

##### å¸ƒå°”ç±»å‹

`bool`å¤§å°1Byteï¼Œå–å€¼`true`å’Œ`false`

##### å­—ç¬¦ç±»å‹

`char`  è·Ÿcppç±»ä¼¼ï¼Œå­—ç¬¦ç”¨å•å°å·ï¼Œå­—ç¬¦ä¸²ç”¨åŒå¼•å·

`rust`çš„å­—ç¬¦ç±»å‹å¤§å°ä¸º4Byteï¼Œé‡‡ç”¨Unicodeæ ‡é‡ï¼Œä¸€ä¸ªå­—èŠ‚å¯ä»¥å®¹çº³èŒƒå›´è¿œè¶…ASCIIï¼Œæ¯”å¦‚å¯ä»¥æ”¾ä¸‹emoji ğŸ˜

##### å¤åˆç±»å‹

å¤åˆç±»å‹æŒ‡çš„æ˜¯æŠŠå¤šä¸ªå€¼ç»„åˆæˆä¸€ä¸ªç±»å‹ã€‚`rust`ä¸¤ç§åŸºæœ¬çš„ç¬¦åˆç±»å‹æ˜¯å…ƒç»„å’Œæ•°ç»„

###### å…ƒç»„

å¤šç§ç±»å‹çš„å¤šä¸ªå€¼æ”¾åˆ°ä¸€ä¸ªå¤åˆç±»å‹ä¸­ï¼Œ**é•¿åº¦å›ºå®š**ï¼Œè¯­æ³•æ˜¯åœ¨å°æ‹¬å·ä¸­ç”¨é€—å·é—´éš”

å¦‚`let tup: (i32, f64, u8) = (500, 6.4, 1)`

æƒ³è¦ä»å…ƒç»„ä¸­å–å€¼éœ€è¦ä½¿ç”¨æ¨¡å¼åŒ¹é…æ¥è§£æ„ï¼ˆç±»ä¼¼pythonå†™æ³•ï¼‰

```rust
fn main() {
    let tup = (500, 6.4, 1);

    let (x, y, z) = tup;

    println!("The value of y is: {}", y);
}
```

ä¹Ÿå¯ä»¥æŒ‰é¡ºåºç”¨ç´¢å¼•åŠ `.`å–å¾—ï¼Œä¸‹æ ‡ä»**0**å¼€å§‹ï¼Œå¦‚å–`f64`ç±»å‹çš„å…ƒç´ åº”è¯¥ä½¿ç”¨`tup.1`

ç©ºå…ƒç»„æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹ï¼Œä¹Ÿå†™æˆ`()`ï¼Œè¢«ç§°ä¸º**å•å…ƒç±»å‹**ï¼Œè¯¥å€¼è¢«ç§°ä¸º**å•å…ƒå€¼**ã€‚å¦‚æœè¡¨è¾¾å¼éƒ¨è¿”å›ä»»ä½•å…¶ä»–å€¼ï¼Œå°±**éšå¼è¿”å›å•å…ƒå€¼**



###### æ•°ç»„

æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ å¿…é¡»æœ‰ç›¸åŒç±»å‹ï¼Œä¸”`rust`ä¸­çš„æ•°ç»„ä¹Ÿæ˜¯**å®šé•¿**çš„ï¼Œä½¿ç”¨æ–¹æ³•æ˜¯åœ¨æ–¹æ‹¬å·ä¸­ç”¨é€—å·åˆ†å‰²å®šä¹‰ã€‚å¦‚`let a = [1, 2, 3, 4]`

æ•°ç»„ä¸€èˆ¬ç”¨äºéœ€è¦å°†æ•°æ®åˆ†é…åˆ°**æ ˆè€Œéå †**æ—¶ï¼Œ`rust`ä¸­ä¹Ÿæœ‰`vector`ï¼Œåº”ä¼˜å…ˆä½¿ç”¨`vector`

ä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šç±»å‹å’Œé•¿åº¦å®šä¹‰æ•°ç»„ï¼Œå¦‚`let a: [i32; 5] = [1, 2, 3, 4, 5]`

å¦‚æœæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½ç›¸åŒï¼Œå¯ä»¥ç›´æ¥å€¼å’Œä¸ªæ•°å®šä¹‰ï¼Œå¦‚`let a = [3; 5]`å®šä¹‰äº†5ä¸ª3ç»„æˆçš„æ•°ç»„ï¼ˆç€ä¸€å—å’Œmatlabè¯­æ³•å¾ˆåƒã€‚

æ•°ç»„çš„å…ƒç´ è®¿é—®ç”¨`[]`

åœ¨è¿è¡Œæ—¶è®¿é—®è¶…å‡ºèŒƒå›´çš„å€¼æ—¶ä¼š`panic`è€Œä¸æ˜¯åƒCä¸€æ ·ç¨€é‡Œç³Šæ¶‚è¿è¡Œç€ã€‚



### å‡½æ•°

`main`å‡½æ•°æ˜¯ç¨‹åºå…¥å£ç‚¹ï¼Œ`rust`ä¸­å‡½æ•°ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åæ³•ï¼Œå³æ‰€æœ‰å­—æ¯éƒ½æ˜¯å°å†™çš„å¹¶ä¸”ç”¨ä¸‹åˆ’çº¿æ¥åˆ†å‰²å•è¯ã€‚`rust`ä¸åœ¨æ„å‡½æ•°å®šä¹‰ä½ç½®ï¼Œåªè¦å®šä¹‰è¿‡å°±è¡Œã€‚

å‡½æ•°å¿…é¡»å£°æ˜æ¯ä¸ªå‚æ•°çš„ç±»å‹(ç±»ä¼¼c/cpp)ï¼Œå¤šä¸ªå‚æ•°æ—¶ç”¨é€—å·åˆ†éš”ã€‚

#### è¯­å¥å’Œè¡¨è¾¾å¼

å‡½æ•°ä½“ç”±ä¸€ç³»åˆ—è¯­å¥ç»„æˆï¼Œä½†ä¹Ÿå¯ä»¥é€‰æ‹©ç”¨è¡¨è¾¾å¼ç»“å°¾ã€‚`rust`æ˜¯ä¸€é—¨ç‰¹åˆ«çš„**åŸºäºè¡¨è¾¾å¼**çš„è¯­è¨€ï¼Œé€‰æ‹©è¯­å¥æˆ–è€…è¡¨è¾¾å¼å°†ä¼šå½±å“åˆ°å‡½æ•°ä½“ã€‚

**è¯­å¥**(statement)æ‰§è¡Œæ“ä½œä½†ä¸è¿”å›å€¼ã€‚å¦‚`let y = 6;`

**è¡¨è¾¾å¼**(expression)è®¡ç®—å¹¶äº§ç”Ÿä¸€ä¸ªå€¼ï¼Œè¯­å¥ä¸­çš„ä¸€éƒ¨åˆ†ä¹Ÿå¯ä»¥æ˜¯è¡¨è¾¾å¼ï¼Œæ¯”å¦‚ä¸Šé¢çš„`6`å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ã€‚å‡½æ•°**è°ƒç”¨**æ˜¯è¡¨è¾¾å¼ï¼Œå®è°ƒç”¨ä¹Ÿæ˜¯è¡¨è¾¾å¼ï¼Œåˆ›å»ºæ–°ä½œç”¨åŸŸçš„å¤§æ‹¬å·`{}`ä¹Ÿæ˜¯è¡¨è¾¾å¼

å‡½æ•°**å®šä¹‰**æœ¬èº«ä¹Ÿæ˜¯è¯­å¥ã€‚å’Œcèµ‹å€¼è¯­å¥ä¸åŒï¼Œè¯­å¥æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä¸èƒ½å†™è¿ç­‰å¦‚`let x = (let y = 6);`



è¡¨è¾¾å¼çš„ç»“å°¾æ²¡æœ‰åˆ†å·ã€‚å¦‚æœåœ¨è¡¨è¾¾å¼æœ«å°¾åŠ ä¸Šåˆ†å·ï¼Œå°±ä¼šè½¬æ¢ä¸ºä¸ä¼šè¿”å›å€¼çš„è¯­å¥

```rust
fn main() {
    let y = {
        let x = 3;
        x + 1   // æ²¡æœ‰;
    };

    println!("The value of y is: {}", y);
}
```

å¦‚å…¶ä¸­yåçš„é‚£ä¸€ä¸²`{}`é‡Œçš„å°±æ˜¯è¡¨è¾¾å¼

#### å¸¦è¿”å›å€¼çš„å‡½æ•°

`rust`ä¸åƒcä¸€æ ·å†™æ˜¾å¼è¿”å›å€¼ï¼Œé»˜è®¤å¯ä»¥ç”¨éšå¼è¿”å›æœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œå¦‚æœç”¨`return`å…³é”®å­—å’ŒæŒ‡å®šå€¼ï¼Œå¯ä»¥ä»å‡½æ•°æå‰è¿”å›ã€‚å‡½æ•°è¿”å›å€¼çš„ç±»å‹å†™åœ¨å‚æ•°åˆ—è¡¨åç”¨ `->`æ¥ç±»å‹è¡¨ç¤ºã€‚

```rust
fn five() -> i32 {
    5
}

fn main() {
    let x = five();

    println!("The value of x is: {}", x);
}
```

å¦‚æœå¸¦ä¸Šåˆ†å·ï¼Œä¼šè®©å‡½æ•°ä»è¡¨è¾¾å¼å˜æˆè¯­å¥ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼ˆå³ä¼šè¿”å›ä¸€ä¸ªç©ºå…ƒç»„ç±»å‹è¡¨ç¤ºæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œå¯¼è‡´ç±»å‹å’Œi32ä¸åŒ¹é…æŠ¥é”™ã€‚



### æ³¨é‡Š

`rust`é€šç”¨æ³¨é‡Šæ˜¯`//`ï¼Œè¿˜æœ‰ä¸€ç§æ–‡æ¡£æ³¨é‡Šç•™å¾…ä¹‹åå†è¯´ã€‚



### æ§åˆ¶æµ

#### ifè¡¨è¾¾å¼

if elseç”¨æ³•ç±»ä¼¼cä¸­ï¼Œä½†æ˜¯ifåå¿…é¡»æ˜¯ä¸€ä¸ª`bool`ç±»å‹çš„è¡¨è¾¾å¼ï¼Œ`rust`ä¸ä¼šè‡ªåŠ¨æŠŠéå¸ƒå°”å€¼è½¬æ¢æˆå¸ƒå°”å€¼ã€‚

åœ¨å¤šä¸ªifä¸²else ifä¸­ä¼šæ£€æµ‹ç¬¬ä¸€ä¸ªä¸ºçœŸçš„ifæ¡ä»¶æ‰§è¡Œ

##### letä¸­ä½¿ç”¨if

ç±»ä¼¼äºcppä¸­çš„ä¸‰ç›®è¿ç®—ç¬¦ ?:

å¦‚

```rust
fn main() {
    let condition = true;
    let number = if condition { 5 } else { 6 };

    println!("The value of number is: {}", number);
}
```

ifè¡¨è¾¾å¼åœ¨ifåˆ†æ”¯å’Œelseåˆ†æ”¯çš„ç»“æœå¿…é¡»æ˜¯ç›¸åŒç±»å‹ï¼Œä¸åŒ¹é…çš„è¯ä¼šæŠ¥é”™ã€‚

#### å¾ªç¯

`rust`æœ‰ä¸‰ç§å¾ªç¯ï¼Œ`loop` `while` `for`

##### loop

æ— æ¡ä»¶å¾ªç¯ï¼Œå¯ç”¨continueå’Œbreakè·³å‡ºï¼Œä½¿ç”¨æ—¶å¯ä»¥å¸¦ä¸Šå¾ªç¯æ ‡ç­¾ï¼ˆ`loop label`ï¼‰é…åˆä½¿ç”¨æ¥è·³å‡ºæŒ‡å®šçš„å¾ªç¯è€Œéé»˜è®¤çš„å†…å±‚å¾ªç¯

```rust
// æ— æ§åˆ¶loop
fn main() {
    loop {
        println!("again!");
    }
}
```

```rust
// å¸¦æ§åˆ¶loop
fn main() {
    let mut count = 0;
    'counting_up: loop {
        println!("count = {}", count);
        let mut remaining = 10;

        loop {
            println!("remaining = {}", remaining);
            if remaining == 9 {
                break;
            }
            if count == 2 {
                break 'counting_up;
            }
            remaining -= 1;
        }

        count += 1;
    }
    println!("End count = {}", count);
}
```

##### while

ç”¨æ³•ç±»ä¼¼cï¼Œä¸è¿‡æ¡ä»¶ä¸ç”¨æ‰“æ‹¬å·ï¼Œä¸”å¿…é¡»ä¸º`bool`ç±»å‹

##### for

`rust`ä¸­çš„forå¾ªç¯å¯ä»¥å®ç°ç±»ä¼¼`python`ä¸­ç”¨æ³•ï¼Œä¸»è¦ç”¨äºéå†æ—¶æœ‰æ•ˆé¿å…`panic`

```rust
fn main() {
    let a = [10, 20, 30, 40, 50];

    for element in a {
        println!("the value is: {}", element);
    }
}
```

ä¸€ä¸ªåè½¬åŒºé—´å€’è®¡æ—¶çš„ä¾‹å­

```rust
fn main() {
    for number in (1..4).rev() {
        println!("{}!", number);
    }
    println!("LIFTOFF!!!");
}
```

ä»¥ä¸Šä»£ç ä¸­revæ˜¯åè½¬æ–¹æ³•ã€‚



## Char4 æ‰€æœ‰æƒ

æ‰€æœ‰æƒè®©`rust`æ— éœ€åƒåœ¾å›æ”¶å™¨ï¼ˆGC-garbage collectorï¼‰å°±å¯ä»¥å®ç°å†…å­˜å®‰å…¨ã€‚

### ä»€ä¹ˆæ˜¯æ‰€æœ‰æƒ

å¯¹äºç³»ç»Ÿå†…å­˜çš„æ§åˆ¶ï¼ŒGCæ˜¯ä¸æ–­å¯»æ‰¾ä¸å†ä½¿ç”¨çš„å†…å­˜ï¼ŒC/CPPä¸­æ˜¯éœ€è¦å¼€å‘è€…æ‰‹åŠ¨åˆ†é…å’Œé‡Šæ”¾ï¼Œè€Œ`rust`ä½¿ç”¨æ‰€æœ‰æƒæ¥ç®¡ç†ç³»ç»Ÿå†…å­˜ï¼Œåœ¨ç¼–è¯‘æ—¶é€šè¿‡ä¸€ç³»åˆ—æ£€æŸ¥ï¼Œåœ¨**è¿è¡Œæ—¶ï¼Œä¸ä¼šé€ æˆå¼€é”€**

ä»¥ä¸‹ç¤ºä¾‹ï¼ŒåŸºäºå­—ç¬¦ä¸²è¯´æ˜ã€‚



#### å †å’Œæ ˆ

`rust`ä¸­éœ€è¦æ˜¾å¼è€ƒè™‘æ•°æ®æ”¾åœ¨å †è¿˜æ˜¯æ ˆä¸Šï¼Œä¸¤è€…ç»“æ„ä¸åŒã€‚

`stack`æ ˆæ˜¯åè¿›å…ˆå‡ºçš„ï¼Œæ ˆä¸Šæ‰€æœ‰çš„æ•°æ®å¿…é¡»å ç”¨**å·²çŸ¥ä¸”å›ºå®šçš„å¤§å°**ã€‚å¦‚æœåœ¨ç¼–è¯‘æ—¶å¤§å°æœªçŸ¥æˆ–è€…å¯èƒ½å˜åŒ–çš„æ•°æ®åº”è¯¥æ”¾åœ¨å †ä¸Šã€‚**æŠŠæ•°æ®æ¨å…¥æ ˆä¸è¢«è®¤ä¸ºæ˜¯åˆ†é…**ã€‚

`heap`å †ä¸­çš„æ•°æ®æ˜¯æ— ç»„ç»‡çš„ã€‚å¾€å †é‡Œæ”¾æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚ä¸€å®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œç„¶åå†…å­˜åˆ†é…å™¨ï¼ˆmemory allocatorï¼‰ä¼šåœ¨å †é‡ŒæŸå¤„æ‰¾åˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç©ºä½ï¼Œæ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œç„¶åè¿”å›ä¸€ä¸ªæŒ‡é’ˆã€‚è¯¥è¿‡ç¨‹ç§°ä¸ºåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼ˆallocating on the heapï¼‰

å…¥æ ˆæ¯”å †ä¸Šåˆ†é…å†…å­˜æ›´å¿«ï¼Œå› ä¸ºä¸éœ€è¦åˆ†é…å™¨æœç´¢ç©ºé—´ï¼Œä½ç½®æ€»æ˜¯åœ¨æ ˆé¡¶ã€‚

è®¿é—®å †ä¸Šçš„æ•°æ®æ¯”æ ˆä¸Šçš„æ›´æ…¢ï¼Œå› ä¸ºéœ€è¦é€šè¿‡æŒ‡é’ˆè®¿é—®ã€‚

ä¸C/CPPç±»ä¼¼ï¼Œä»£ç è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¼ ç»™å‡½æ•°çš„å€¼å’Œå‡½æ•°çš„å±€éƒ¨å˜é‡å…¥æ ˆã€‚å‡½æ•°ç»“æŸæ—¶ï¼Œè¿™äº›å€¼å‡ºæ ˆã€‚

è·Ÿè¸ªæ­£åœ¨ä½¿ç”¨çš„å †ä¸Šçš„æ•°æ®ï¼ˆC/CPPä¸­å†…å­˜æ³„æ¼çš„åŸå› ï¼‰ï¼Œæœ€å¤§é™åº¦å‡å°‘å †ä¸Šé‡å¤æ•°æ®ï¼Œå¹¶æ¸…ç†å †ä¸Šçš„æ­»æ•°æ®ï¼Œè¿™å°±æ˜¯æ‰€æœ‰æƒç³»ç»Ÿå¤„ç†çš„é—®é¢˜ã€‚

#### æ‰€æœ‰æƒè§„åˆ™

ä¸‰æ¡åŸºæœ¬è§„åˆ™ï¼š

* `rust`ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºå…¶`æ‰€æœ‰è€…`(owner)çš„å˜é‡
* å€¼åœ¨ä»»ä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…
* å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ

#### å˜é‡ä½œç”¨åŸŸ

**ä½œç”¨åŸŸ**ï¼ˆscopeï¼‰æ˜¯ä¸€ä¸ª**é¡¹**ï¼ˆitemï¼‰åœ¨ç¨‹åºä¸­æœ‰æ•ˆçš„èŒƒå›´ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º

```rust
fn main() {
    {                      // s åœ¨è¿™é‡Œæ— æ•ˆ, å®ƒå°šæœªå£°æ˜
        let s = "hello";   // ä»æ­¤å¤„èµ·ï¼Œs å¼€å§‹æœ‰æ•ˆ
        				   // sç»‘å®šäº†ä¸€ä¸ªç¡¬ç¼–ç ç»‘å®šè¿›ç¨‹åºä»£ç çš„å­—ç¬¦ä¸²å­—é¢é‡

        // ä½¿ç”¨ s
    }                      // æ­¤ä½œç”¨åŸŸå·²ç»“æŸï¼Œs ä¸å†æœ‰æ•ˆ
}
```

ä»sè¿›å…¥ä½œç”¨åŸŸæ—¶ï¼Œå®ƒå°±æ˜¯æœ‰æ•ˆçš„ï¼Œä¸€ç›´æŒç»­åˆ°ç¦»å¼€ä½œç”¨åŸŸä¸ºæ­¢

#### å†…å­˜ä¸åˆ†é…

å­—ç¬¦ä¸²å­—é¢é‡æ˜¯ç¡¬ç¼–ç è¿›ç¨‹åºçš„ï¼Œä¸å¯å˜ã€‚ç”¨`String`æ¥ç®¡ç†è¢«åˆ†é…åˆ°å †ä¸Šçš„æ•°æ®ï¼Œç”¨äºå­˜å‚¨åœ¨ç¼–è¯‘æ—¶ä½ç½®å¤§å°çš„æ–‡æœ¬ï¼Œä½¿ç”¨`from`åˆ›å»ºæ–¹æ³•å¦‚ä¸‹

`let s = String::from("hello");`

`::`ç”¨æ³•ç±»æ¯”CPPä¸­å‘½åç©ºé—´

å¯¹å…¶è¿›è¡Œä¿®æ”¹å¦‚ä¸‹

```rust
fn main() {
    let mut s = String::from("hello");
    s.push_str(", world!"); // push_str() åœ¨å­—ç¬¦ä¸²åè¿½åŠ å­—é¢å€¼
    println!("{}", s); // å°†æ‰“å° `hello, world!`
}
```

å¯¹äº`String`ä¸ºäº†æ”¯æŒä¸€ä¸ªå¯å˜ï¼Œå¯å¢é•¿çš„æ–‡æœ¬ç‰‡æ®µï¼Œéœ€è¦åœ¨å †ä¸Šåˆ†é…ä¸€å—å¯æ”¹å˜å¤§å°çš„ç©ºé—´ï¼š

* å¿…é¡»åœ¨è¿è¡Œæ—¶å‘å†…å­˜åˆ†é…å™¨è¯·æ±‚å†…å­˜
* éœ€è¦ä¸€ä¸ªå¤„ç†å®Œ`String`åæŠŠå†…å­˜è¿”å›ç»™åˆ†é…å™¨çš„æ–¹æ³•ï¼ˆç±»ä¼¼äºææ„ï¼‰

ç¬¬ä¸€éƒ¨åˆ†å„ä¸ªè¯­è¨€æ¯”è¾ƒç±»ä¼¼ï¼Œç¬¬äºŒéƒ¨åˆ†åƒå·®ä¸‡åˆ«ï¼Œå¸¦GCçš„ç”¨GCå¤„ç†ï¼Œæ‰‹åŠ¨åˆ†é…éœ€è¦ç²¾ç¡®ä¸€ä¸ª`allocate`é…å¯¹ä¸€ä¸ª`free`

`rust`ä½¿ç”¨ç­–ç•¥æ˜¯ï¼šå†…å­˜åœ¨æ‹¥æœ‰å®ƒçš„å˜é‡ï¼›ç¦»å¼€ä½œç”¨åŸŸåå°±è¢«è‡ªåŠ¨é‡Šæ”¾

```rust
fn main() {
    {
        let s = String::from("hello"); // ä»æ­¤å¤„èµ·ï¼Œs å¼€å§‹æœ‰æ•ˆ

        // ä½¿ç”¨ s
    }                                  // æ­¤ä½œç”¨åŸŸå·²ç»“æŸï¼Œ
                                       // s ä¸å†æœ‰æ•ˆ
}
```

`rust`ä¸­å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œè°ƒç”¨çš„ç‰¹æ®Šå‡½æ•°è¢«ç§°ä¸º`drop`ï¼Œ`rust`ä¼šåœ¨ç»“å°¾çš„`}`å¤„è‡ªåŠ¨è°ƒç”¨`drop`ã€‚åœ¨CPPä¸­ï¼Œè¿™ç§ç»“æŸæ—¶é‡Šæ”¾èµ„æºçš„æ¨¡å¼ä¸ºèµ„æºè·å–å³åˆå§‹åŒ–ï¼ˆRAII-Resource Acquisition Is Initializationï¼‰

##### å˜é‡ä¸æ•°æ®äº¤äº’ï¼ˆä¸€ï¼‰ï¼šç§»åŠ¨

```rust
fn main() {
    let x = 5;
    let y = x;
}
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;
}
```

ä¸¤ç§ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ•´æ•°ï¼Œæœ‰å·²çŸ¥å›ºå®šå¤§å°çš„ç®€å•å€¼ï¼Œæ‰€ä»¥ä¸¤ä¸ªéƒ½è¢«æ”¾åœ¨æ ˆä¸Šã€‚

ç¬¬äºŒä¸ªçœ‹ä¸Šå»ç±»ä¼¼ï¼Œä½†æ˜¯åº•å±‚å®ç°ä¸ä¸€æ ·ã€‚

`String`çš„åº•å±‚å®ç°å¦‚ä¸‹ï¼Œå·¦è¾¹ä¸‰ä¸ªæ”¾åœ¨æ ˆä¸Šï¼Œåˆ†åˆ«æ˜¯æŒ‡å‘å †ä¸Šçš„æŒ‡é’ˆï¼Œé•¿åº¦ï¼Œå®¹é‡ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æ”¾åœ¨å †ä¸Šã€‚

![String in memory](https://rustwiki.org/zh-CN/book/img/trpl04-01.svg)

åœ¨èµ‹å€¼æ—¶ä¼šå¤åˆ¶æ ˆä¸Šæ•°æ®ï¼Œè€Œä¸ä¼šå¤åˆ¶å †ä¸Šæ•°æ®ï¼Œç»“æœå¦‚ä¸‹

![s1 and s2 pointing to the same value](https://rustwiki.org/zh-CN/book/img/trpl04-02.svg)

å‚è€ƒå‰é¢æåˆ°çš„ï¼Œå½“ä¸€ä¸ªå˜é‡ç¦»å¼€ä½œç”¨åŸŸåä¼šè°ƒç”¨`drop`ä½†æ˜¯å¤åˆ¶åä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘äº†åŒä¸€ä½ç½®ï¼Œæ­¤æ—¶s1ï¼Œs2éƒ½ç¦»å¼€æ—¶ä¼šäºŒæ¬¡é‡Šæ”¾(double free)ä¸€ä¸ªåŒºåŸŸã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œåœ¨`let s2 = s1`åä¼šè®¤ä¸º`s1`ä¸å†æœ‰æ•ˆï¼Œæ•…ä¸ä¼šåœ¨`s1`ç¦»å¼€ä½œç”¨åŸŸåæ¸…ç†ä»»ä½•ä¸œè¥¿ã€‚å¦‚ä¸‹ä»£ç 

```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;

    println!("{}, world!", s1);// ä¼šå› ä¸ºæ— æ•ˆå¼•ç”¨è€ŒæŠ¥é”™
}
```

åªå¤åˆ¶æŒ‡é’ˆè€Œä¸å¤åˆ¶å€¼å¾ˆåƒæµ…æ‹·è´ï¼Œä½†ä¸åŒçš„æ˜¯è¿™é‡Œè®©ç¬¬ä¸€ä¸ªå˜é‡æ— æ•ˆäº†ï¼Œæ‰€ä»¥è¢«ç§°ä¸ºç§»åŠ¨(move)ã€‚

åŒæ—¶ä¹Ÿéšå«äº†ä¸€ä¸ªè®¾è®¡é€‰æ‹©ï¼š`rust`æ°¸è¿œä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®çš„æ·±æ‹·è´ï¼Œä»»ä½•è‡ªåŠ¨çš„å¤åˆ¶å¯ä»¥å¿½ç•¥å¯¹æ€§èƒ½çš„å½±å“ã€‚

##### å˜é‡ä¸æ•°æ®äº¤äº’çš„æ–¹å¼(äºŒ)ï¼šå…‹éš†

ç”¨äºæ·±æ‹·è´æ—¶ï¼Œä½¿ç”¨`clone`çš„é€šç”¨å‡½æ•°ï¼Œä½¿ç”¨å¦‚ä¸‹æ‰€ç¤º

```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1.clone();

    println!("s1 = {}, s2 = {}", s1, s2);
}
```

è°ƒç”¨`clone`æ—¶å¯èƒ½ä¼šå‡ºç°å¤§é‡æ€§èƒ½æ¶ˆè€—

ä¸æ•´å‹ä¸åŒï¼Œæ•´å‹æˆ–è€…å­—é¢é‡è¿™ç§åœ¨ç¼–è¯‘æ—¶å·²çŸ¥å¤§å°çš„ç±»å‹è¢«æ•´ä¸ªå­˜å‚¨åœ¨æ ˆä¸Šï¼Œå…¶æ‹·è´ä¸ä¼šåŒºåˆ†æ·±æµ…æ‹·è´ï¼Œä¹Ÿä¸ä¼šåœ¨æ‹·è´åè®©å‰è€…æ— æ•ˆã€‚

`rust`åœ¨åº•å±‚ä½¿ç”¨çš„æ˜¯`Copy trait`çš„ç‰¹æ®Šæ ‡æ³¨ï¼Œç”¨äº†è¿™æ ·æ ‡æ³¨çš„ç±»å‹ï¼Œåœ¨èµ‹å€¼åä¸ä¼šä½¿æ—§å˜é‡æ— æ•ˆã€‚åŒæ—¶`rust`ä¸å…è®¸è‡ªèº«æˆ–å…¶ä»»ä½•éƒ¨åˆ†å®ç°äº†`Drop trait`çš„ç±»å‹ä½¿ç”¨`Copy trait`ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å®ç°äº†`copy`çš„ç±»å‹ï¼š

* æ‰€æœ‰çš„æ•´æ•°ç±»å‹
* å¸ƒå°”ç±»å‹
* æ‰€æœ‰çš„æµ®ç‚¹ç±»å‹
* å­—ç¬¦ç±»å‹
* å…ƒç»„ï¼Œå½“å…¶æ‰€åŒ…å«çš„ç±»å‹éƒ½å®ç°äº†`Copy`æ—¶

#### æ‰€æœ‰æƒä¸å‡½æ•°

æŠŠå€¼ä¼ é€’ç»™å‡½æ•°åœ¨è¯­ä¹‰ä¸Šå’Œç»™å˜é‡èµ‹å€¼ç±»ä¼¼ï¼Œå¯ä»¥å‘ç”Ÿç§»åŠ¨å’Œå…‹éš†ã€‚å¦‚ä¸‹æ‰€ç¤º

```rust
fn main() {
  let s = String::from("hello");  // s è¿›å…¥ä½œç”¨åŸŸ

  takes_ownership(s);             // s çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°é‡Œ ...
                                  // ... æ‰€ä»¥åˆ°è¿™é‡Œä¸å†æœ‰æ•ˆ

  let x = 5;                      // x è¿›å…¥ä½œç”¨åŸŸ

  makes_copy(x);                  // x åº”è¯¥ç§»åŠ¨å‡½æ•°é‡Œï¼Œ
                                  // ä½† i32 æ˜¯ Copy çš„ï¼Œæ‰€ä»¥åœ¨åé¢å¯ç»§ç»­ä½¿ç”¨ x

} // è¿™é‡Œ, x å…ˆç§»å‡ºäº†ä½œç”¨åŸŸï¼Œç„¶åæ˜¯ sã€‚ä½†å› ä¸º s çš„å€¼å·²è¢«ç§»èµ°ï¼Œ
  // æ‰€ä»¥ä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ

fn takes_ownership(some_string: String) { // some_string è¿›å…¥ä½œç”¨åŸŸ
  println!("{}", some_string);
} // è¿™é‡Œï¼Œsome_string ç§»å‡ºä½œç”¨åŸŸå¹¶è°ƒç”¨ `drop` æ–¹æ³•ã€‚å ç”¨çš„å†…å­˜è¢«é‡Šæ”¾

fn makes_copy(some_integer: i32) { // some_integer è¿›å…¥ä½œç”¨åŸŸ
  println!("{}", some_integer);
} // è¿™é‡Œï¼Œsome_integer ç§»å‡ºä½œç”¨åŸŸã€‚ä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ
```

è¿”å›å€¼ä¹Ÿå¯ä»¥è½¬ç§»æ‰€æœ‰æƒï¼Œå¦‚ä¸‹ä»£ç 

```rust
fn main() {
  let s1 = gives_ownership();         // gives_ownership å°†è¿”å›å€¼
                                      // ç§»ç»™ s1

  let s2 = String::from("hello");     // s2 è¿›å…¥ä½œç”¨åŸŸ

  let s3 = takes_and_gives_back(s2);  // s2 è¢«ç§»åŠ¨åˆ°
                                      // takes_and_gives_back ä¸­,
                                      // å®ƒä¹Ÿå°†è¿”å›å€¼ç§»ç»™ s3
} // è¿™é‡Œ, s3 ç§»å‡ºä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒã€‚s2 ä¹Ÿç§»å‡ºä½œç”¨åŸŸï¼Œä½†å·²è¢«ç§»èµ°ï¼Œ
  // æ‰€ä»¥ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿã€‚s1 ç§»å‡ºä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒ

fn gives_ownership() -> String {           // gives_ownership å°†è¿”å›å€¼ç§»åŠ¨ç»™
                                           // è°ƒç”¨å®ƒçš„å‡½æ•°

  let some_string = String::from("yours"); // some_string è¿›å…¥ä½œç”¨åŸŸ

  some_string                              // è¿”å› some_string å¹¶ç§»å‡ºç»™è°ƒç”¨çš„å‡½æ•°
}

// takes_and_gives_back å°†ä¼ å…¥å­—ç¬¦ä¸²å¹¶è¿”å›è¯¥å€¼
fn takes_and_gives_back(a_string: String) -> String { // a_string è¿›å…¥ä½œç”¨åŸŸ

  a_string  // è¿”å› a_string å¹¶ç§»å‡ºç»™è°ƒç”¨çš„å‡½æ•°
}
```

æ‰€æœ‰æƒéµå¾ªçš„ç›¸åŒæ¨¡å¼ï¼šå°†å€¼èµ‹ç»™å¦ä¸€ä¸ªå˜é‡æ—¶ç§»åŠ¨å®ƒã€‚å½“æŒæœ‰å †é‡Œæ•°æ®å€¼çš„å˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶ç”¨`drop`æ¸…ç†æ‰ã€‚

ä¸€ä¸ªå¸¸ç”¨çš„åœºæ™¯æ˜¯æ€ä¹ˆä½¿ç”¨å€¼è€Œä¸éœ€è¦ä¸“é—¨è¿”å›æ‰€æœ‰æƒï¼Œä¸ºæ­¤æä¾›çš„åŠŸèƒ½æ˜¯å¼•ç”¨(reference)

### å¼•ç”¨ä¸å€Ÿç”¨

#### åŸºæœ¬æ¦‚å¿µ

ä¸ä½¿ç”¨å¼•ç”¨æ—¶ä¸ºäº†å°†å‚æ•°çš„ä½¿ç”¨æƒè¿”å›ï¼Œä¸€ä¸ªå¸¸ç”¨æ–¹æ³•æ˜¯è¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œå¦‚è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦çš„ä»£ç å¦‚ä¸‹

```rust
fn main() {
    let s1 = String::from("hello");

    let (s2, len) = calculate_length(s1);

    println!("The length of '{}' is {}.", s2, len);
}

fn calculate_length(s: String) -> (String, usize) {
    let length = s.len(); // len() è¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦

    (s, length)
}
```

æ˜¾å¾—éå¸¸å½¢å¼ä¸»ä¹‰ï¼Œä½¿ç”¨å¼•ç”¨çš„æ”¹è¿›æ–¹æ¡ˆå¦‚ä¸‹

```rust
fn main() {
    let s1 = String::from("hello");

    let len = calculate_length(&s1);

    println!("The length of '{}' is {}.", s1, len);
}

fn calculate_length(s: &String) -> usize {
    s.len()
}
```

å¼•ç”¨ï¼ˆ`&`ï¼‰å…è®¸ä½¿ç”¨å€¼è€Œä¸è·å–ä½¿ç”¨æƒ

ä¸CPPç±»ä¼¼ï¼Œæœ‰è§£å¼•ç”¨æ“ä½œï¼ˆdereferencingï¼‰ä½¿ç”¨`*`è¿ç®—ç¬¦

ä»¥ä¸Šä½¿ç”¨å¼•ç”¨çš„ç¤ºæ„å›¾å¦‚ä¸‹

![&String s pointing at String s1](https://rustwiki.org/zh-CN/book/img/trpl04-05.svg)

`&s1`åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘å€¼`s1`çš„å¼•ç”¨ï¼Œä½†æ˜¯å¹¶ä¸æ‹¥æœ‰å€¼ï¼Œæ•…å¼•ç”¨åœæ­¢æ—¶ï¼Œå…¶æŒ‡å‘çš„å€¼ä¹Ÿä¸ä¼šè¢«ä¸¢å¼ƒï¼Œå‡½æ•°ä½¿ç”¨å¼•ç”¨ä½œä¸ºå‚æ•°æ—¶ï¼Œæ— éœ€è¿”å›å€¼æ¥äº¤è¿˜æ‰€æœ‰æƒï¼Œå› ä¸ºå‹æ ¹å„¿æœªæ›¾æ‹¥æœ‰è¿‡ã€‚

**åˆ›å»ºä¸€ä¸ªå¼•ç”¨çš„è¡Œä¸ºç§°ä¸ºå€Ÿç”¨ï¼ˆborrowï¼‰**

ä¸CPPä¸åŒï¼Œä¿®æ”¹å¼•ç”¨æŒ‡å‘çš„å˜é‡æ˜¯ä¸è¡Œçš„ï¼Œå˜é‡é»˜è®¤ä¸å¯å˜ï¼Œå¼•ç”¨ä¹Ÿä¸€æ ·ã€‚

#### å¯å˜å¼•ç”¨

åŒæ ·åŠ ä¸Š`mut`å…³é”®å­—å°±å¯ä»¥å®ç°å¯¹å¼•ç”¨å˜é‡çš„ä¿®æ”¹

```rust
fn main() {
    let mut s = String::from("hello");

    change(&mut s);
}

fn change(some_string: &mut String) {
    some_string.push_str(", world");
}
```

å¯å˜å¼•ç”¨æœ‰ä¸€ä¸ªé™åˆ¶ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå¯¹æŸä¸€ç‰¹å®šæ•°æ®çš„å¯å˜å¼•ç”¨ï¼Œå¾ˆåƒosä¸­çš„è¯»å†™åŒæ­¥é—®é¢˜ï¼Œç”¨äºé¿å…æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰ï¼Œå…¶å‘ç”Ÿæ¡ä»¶ï¼š

* ä¸¤ä¸ªæˆ–æ›´å¤šæŒ‡é’ˆåŒæ—¶è®¿é—®åŒä¸€æ•°æ®
* è‡³å°‘æœ‰ä¸€ä¸ªæŒ‡é’ˆç”¨æ¥å†™å…¥æ•°æ®
* æ²¡æœ‰åŒæ­¥æ•°æ®è®¿é—®çš„æœºåˆ¶

æ•°æ®ç«äº‰ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼Œä¸”å‡ ä¹æ— æ³•è¿½è¸ªå’Œä¿®å¤ï¼Œ`rust`ç›´æ¥é€‰æ‹©ä¸ç¼–è¯‘å­˜åœ¨æ•°æ®ç«äº‰çš„ä»£ç 

å¯ä»¥é€šè¿‡å¤§æ‹¬å·æ¥åˆ›å»ºæ–°ä½œç”¨åŸŸæ¥é¿å…åœ¨ä¸€ä¸ªä½œç”¨åŸŸä¸­çš„å¯å˜å¼•ç”¨é™åˆ¶ï¼Œå¦‚

```rust
fn main() {
    let mut s = String::from("hello");

    {
        let r1 = &mut s;
    } // r1 åœ¨è¿™é‡Œç¦»å¼€äº†ä½œç”¨åŸŸï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¼•ç”¨
    // æ³¨æ„åˆ°è¿™é‡Œr1ç¦»å¼€ä½œç”¨åŸŸåï¼Œè¿™ä¸ªå˜é‡å®é™…è¢«é‡Šæ”¾ä¸å¯ä½¿ç”¨äº†

    let r2 = &mut s;
}
```

åŒæ ·çš„è§„åˆ™ä¹Ÿå­˜åœ¨äºåŒæ—¶ä½¿ç”¨å¯å˜ä¸ä¸å¯å˜å¼•ç”¨ä¸­ï¼Œå³æ— æ³•åŒæ—¶æ‹¥æœ‰å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨ã€‚

ä¸€ä¸ªå¼•ç”¨çš„ä½œç”¨åŸŸæ˜¯ä»å£°æ˜çš„åœ°æ–¹ä¸€ç›´æŒç»­åˆ°æœ€åä¸€æ¬¡ä½¿ç”¨ï¼ˆæˆ–è€…ç¦»å¼€ä½œç”¨åŸŸè¢«é‡Šæ”¾ï¼‰ä¸ºæ­¢ï¼Œæ•…å¦‚ä¸‹ä»£ç å¯æ­£ç¡®æ‰§è¡Œ

```rust
fn main() {
    let mut s = String::from("hello");

    let r1 = &s; // æ²¡é—®é¢˜
    let r2 = &s; // æ²¡é—®é¢˜
    println!("{} and {}", r1, r2);// å¯ä»¥æŠŠå¼•ç”¨å½“æˆä¸€ä¸ªæŒ‡é’ˆå¯¹è±¡ï¼Œè¢«è°ƒç”¨åå°±dropäº†
    // æ­¤ä½ç½®ä¹‹å r1 å’Œ r2 ä¸å†ä½¿ç”¨

    let r3 = &mut s; // æ²¡é—®é¢˜
    println!("{}", r3);
}
```

`rust`ä½¿ç”¨éè¯æ³•ä½œç”¨åŸŸå£°æ˜å‘¨æœŸ(Non-Lexical Lifetimes NLL)æ¥åˆ¤æ–­ä½œç”¨åŸŸç»“æŸå‰æ˜¯å¦ä¸å†ä½¿ç”¨ã€‚

#### å‚æ‚¬å¼•ç”¨ï¼ˆDangling Referenceï¼‰

ç±»ä¼¼äºC/CPPä¸­çš„å‚æ‚¬æŒ‡é’ˆã€‚å³æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å¯èƒ½å·²ç»è¢«åˆ†é…ç»™å…¶ä»–æŒæœ‰è€…ï¼Œ`rust`ç¼–è¯‘å™¨ç¡®ä¿å¼•ç”¨æ°¸è¿œä¸ä¼šå‚æ‚¬ï¼Œå³å½“æ‹¥æœ‰æ•°æ®å¼•ç”¨æ—¶ï¼Œç¼–è¯‘å™¨ç¡®ä¿**æ•°æ®ä¸ä¼šåœ¨å¼•ç”¨ä¹‹å‰ç¦»å¼€ä½œç”¨åŸŸ**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæŠ¥é”™ç¤ºä¾‹

```rust
fn main() {
    let reference_to_nothing = dangle();
}

fn dangle() -> &String { // dangle è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²çš„å¼•ç”¨

    let s = String::from("hello"); // s æ˜¯ä¸€ä¸ªæ–°å­—ç¬¦ä¸²

    &s // è¿”å›å­—ç¬¦ä¸² s çš„å¼•ç”¨
} // è¿™é‡Œ s ç¦»å¼€ä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒã€‚å…¶å†…å­˜è¢«é‡Šæ”¾ã€‚
  // å±é™©ï¼
```

#### æ€»ç»“

* åœ¨ä»»æ„ç»™å®šæ—¶åˆ»ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆåªèƒ½æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨
* å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„

### åˆ‡ç‰‡Sliceç±»å‹

`Slice`æ˜¯å¦ä¸€ä¸ªæ²¡æœ‰æ‰€æœ‰æƒçš„æ•°æ®ç±»å‹ï¼Œç”¨æ¥å¼•ç”¨é›†åˆä¸­ä¸€æ®µè¿ç»­çš„å…ƒç´ åºåˆ—ï¼Œè€Œä¸ç”¨å¼•ç”¨æ•´ä¸ªé›†åˆ

ä»¥ä¸€ä¸ªä¾‹å­æ¥å¼•å…¥ï¼šç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›åœ¨è¯¥å­—ç¬¦ä¸²ä¸­æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªå•è¯

ä¸éœ€è¦å¾—åˆ°`string`çš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥å‚æ•°ç”¨å¼•ç”¨ï¼Œä½†æ˜¯æ²¡æœ‰çœŸæ­£è·å–éƒ¨åˆ†å­—ç¬¦ä¸²çš„åŠæ³•ï¼Œä½†å¯ä»¥å¦¥åä¸€æ³¢è¿”å›å•è¯ç»“å°¾çš„ç´¢å¼•

```rust
fn first_word(s: &String) -> usize {
    let bytes = s.as_bytes();// å°†`String`è½¬æˆå­—èŠ‚æ•°ç»„

    for (i, &item) in bytes.iter().enumerate() {
        // .item()æ–¹æ³•æ„å»ºè¿­ä»£å™¨ï¼Œè¿”å›é›†åˆä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ 
        // enumerateè¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œå…¶ä¸­iæ˜¯ç´¢å¼•,&itemæ˜¯å•ä¸ªå­—èŠ‚
        if item == b' ' {
            return i;
        }
    }

    s.len()
}

fn main() {
    let mut s = String::from("hello world");

    let word = first_word(&s); // word çš„å€¼ä¸º 5

    s.clear(); // è¿™æ¸…ç©ºäº†å­—ç¬¦ä¸²ï¼Œä½¿å…¶ç­‰äº ""

    // word åœ¨æ­¤å¤„çš„å€¼ä»ç„¶æ˜¯ 5ï¼Œ
    // ä½†æ˜¯æ²¡æœ‰æ›´å¤šçš„å­—ç¬¦ä¸²è®©æˆ‘ä»¬å¯ä»¥æœ‰æ•ˆåœ°åº”ç”¨æ•°å€¼ 5ã€‚word çš„å€¼ç°åœ¨å®Œå…¨æ— æ•ˆï¼
}

```

ç”Ÿæˆå¾—åˆ°çš„wordå’Œsæ˜¯å®Œå…¨æ²¡æœ‰å…³ç³»çš„ï¼Œè¿™æ ·éœ€è¦æ—¶åˆ»æ‹…å¿ƒåŒæ­¥å…³ç³»ï¼Œå•°å—¦ä¸”æ˜“é”™

ä¸ºæ­¤ä½¿ç”¨`Slice`æ–¹æ³•æ¥è§£å†³

#### å­—ç¬¦ä¸²`slice`

`String`ä¸­éƒ¨åˆ†å€¼çš„å¼•ç”¨ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹

```rust
    let s = String::from("hello world");
    let hello = &s[0..5];
    let world = &s[6..11];
```

å…¶ä¸­ç´¢å¼•ä¸ºå·¦é—­å³å¼€åŒºé—´ï¼Œå®é™…åˆ›å»ºçš„ç´¢å¼•å¦‚ä¸‹

![world containing a pointer to the byte at index 6 of String s and a length 5](https://rustwiki.org/zh-CN/book/img/trpl04-06.svg)

ç¬¬ä¸€ä¸ªç´¢å¼•å¯ä»¥çœç•¥è¡¨ç¤ºä»0å¼€å§‹ï¼Œç¬¬äºŒä¸ªç´¢å¼•ä¹Ÿå¯ä»¥çœç•¥è¡¨ç¤ºåˆ°æœ€å

åŒæ—¶çœç•¥åªç•™ç‚¹æ—¶è¡¨ç¤ºå–æ•´ä¸ªå­—ç¬¦ä¸²çš„`slice`æ•…ä»¥ä¸‹å‡ ç§å†™æ³•ç­‰ä»·

```rust
let s = String::from("hello");
let slice = &s[0..2];
let slice = &s[..2];

let len = s.len();
let slice = &s[2..len];
let slice = &s[2..];

let slice = &s[0..len];
let slice = &s[..]
```



å­—ç¬¦ä¸²`slice`çš„ç´¢å¼•åœ¨ASCIIå­—ç¬¦é›†ä½¿ç”¨æ­£å¸¸ï¼Œåœ¨UTF-8å­—ç¬¦ä½¿ç”¨æ—¶éœ€è¦é¢å¤–æ³¨æ„ï¼Œåœ¨åç»­è¡¥å……ã€‚

å†å›å¤´çœ‹ä¹‹å‰çš„éœ€æ±‚ï¼Œç”¨`slice`å®ç°å¦‚ä¸‹

æ³¨æ„åˆ°sliceçš„ç±»å‹å£°æ˜æ˜¯`&str`

```rust
fn first_word(s: &String) -> &str {
    let bytes = s.as_bytes();

    for (i, &item) in bytes.iter().enumerate() {
        if item == b' ' {
            return &s[0..i];
        }
    }

    &s[..]
}

fn main() {
    let mut s = String::from("hello world");

    let word = first_word(&s);

    s.clear(); // error!

    println!("the first word is: {}", word);
}
```

æ­¤æ—¶è¯¥éƒ¨åˆ†å°±ä¼šæŠ¥é”™äº†ï¼Œå› ä¸ºæ‹¥æœ‰äº†`word`æ˜¯`s`çš„ä¸å¯å˜å¼•ç”¨ï¼Œè€Œ`clear`ä¼šè¯•å›¾è°ƒç”¨è·å–ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè€Œæœ€åçš„`println!`åˆä¼šä½¿ç”¨`word`çš„ä¸å¯å˜å¼•ç”¨ï¼Œå³è¯¥ä¸å¯å˜å¼•ç”¨åœ¨æ­¤æ—¶å¿…é¡»è¿˜æ˜¯æœ‰æ•ˆï¼Œå³æ­¤æ—¶ä¼šåŒæ—¶å­˜åœ¨å¯å˜å’Œä¸å¯å˜å¼•ç”¨ï¼Œä¼šç¼–è¯‘å¤±è´¥ã€‚

#### å­—ç¬¦ä¸²å­—é¢é‡å°±æ˜¯`slice`

å­—ç¬¦ä¸²å­—é¢é‡è¢«å‚¨å­˜åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå£°æ˜ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡

`let s = "hello world"`æ—¶ï¼Œ`s`çš„ç±»å‹æ˜¯`&str`å®ƒä¼šæŒ‡å‘äºŒè¿›åˆ¶ç¨‹åºç‰¹å®šä½ç½®çš„`slice`ã€‚è¿™ä¹Ÿå¯¼è‡´å­—ç¬¦ä¸²å­—é¢é‡æ˜¯ä¸å¯å˜çš„ï¼ˆå› ä¸ºå˜å°±æ„å‘³ç€ä¼šéœ€è¦å¦å¤–ä¸€ä¸ªå¼•ç”¨ï¼‰ï¼›`&str`æ˜¯ä¸€ä¸ªä¸å¯å˜å¼•ç”¨

#### ç”¨å­—ç¬¦ä¸²`slice`ä½œä¸ºå‚æ•°

ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥ä¿®æ”¹å‡½æ•°ç­¾åä¸º

`fn first_word(s: &str) -> &str {`

è¿™æ ·åˆ©ç”¨äº†`deref coercions`çš„ä¼˜åŠ¿ï¼Œåœ¨åé¢ç« èŠ‚ä¸­ä¼šä»‹ç»ã€‚

ç°åœ¨åªéœ€è¦äº†è§£ï¼Œå®šä¹‰è·å–ä¸€ä¸ªå­—ç¬¦ä¸²`slice`è€Œä¸æ˜¯`String`å¼•ç”¨çš„å‡½æ•°å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„APIæ›´åŠ é€šç”¨ä¸”ä¸ä¼šä¸¢å¤±ä»»ä½•åŠŸèƒ½

#### å…¶ä»–ç±»å‹çš„`slice`

å…¶ä»–ç±»å‹æ•°ç»„ä¹Ÿæœ‰`slice`ï¼Œå¦‚

```rust
let a = [1, 2, 3, 4];
let slice = &a[1..2];
```

æ­¤æ—¶è¿™ä¸ª`slice`çš„ç±»å‹æ˜¯`&[i32]`ï¼Œåœ¨`vector`éƒ¨åˆ†ä¼šè¿›ä¸€æ­¥è¯¦ç»†æè¿°ã€‚



## Char5 ä½¿ç”¨ç»“æ„ä½“ç»„ç»‡ç›¸å…³è”çš„æ•°æ®

### å®šä¹‰ä¸å®ä¾‹åŒ–ç»“æ„ä½“

#### å®šä¹‰

```rust
struct User {
    active: bool,
    username: String,
    email: String,
    sign_in_count: u64,
}
```

å„é¡¹ç§°ä¸ºå­—æ®µï¼ˆ`field`ï¼‰æ˜¯ä»¥`,`åˆ†éš”

#### åˆ›å»º

```rust
fn main() {
    let user1 = User {
        email: String::from("someone@example.com"),
        username: String::from("someusername123"),
        active: true,
        sign_in_count: 1,
    };
}
```

ç»™å„ä¸ªå­—æ®µèµ‹åˆå€¼ï¼Œä»¥`key: value`çš„å½¢å¼å®Œæˆ

ä½¿ç”¨å­—æ®µå€¼ä½¿ç”¨`.`å–å€¼

`rust`ä¸­çš„ä¸å…è®¸æŸä¸ªå­—æ®µä¸ºå¯å˜çš„ï¼Œå¿…é¡»æ•´ä¸ª**å®ä¾‹**ï¼ˆæ³¨æ„ä¸æ˜¯å®šä¹‰æ—¶ï¼‰æ˜¯å¯å˜çš„

#### å˜é‡ä¸å­—æ®µåŒåæ—¶çš„å­—æ®µåˆå§‹åŒ–ç®€å†™è¯­æ³•

å½“å‚æ•°åä¸å­—æ®µåå®Œå…¨ç›¸åŒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å­—æ®µåˆå§‹åŒ–ç®€å†™è¯­æ³•(field init shorthand)ï¼Œå¦‚ä»¥ä¸‹ä¸¤ä¸ªåˆ†åˆ«æ˜¯ç®€åŒ–å‰åçš„æ„é€ å‡½æ•°å†™æ³•

```rust
fn build_user(email: String, username: String) -> User {
    User {
        email: email,
        username: username,
        active: true,
        sign_in_count: 1,
    }
}
fn build_user(email: String, username: String) -> User {
    User {
        email,
        username,
        active: true,
        sign_in_count: 1,
    }
}
```

#### ä½¿ç”¨ç»“æ„ä½“æ›´æ–°è¯­æ³•ä»å…¶ä»–å®ä¾‹åˆ›å»ºå®ä¾‹

ç»“æ„ä½“æ›´æ–°è¯­æ³•(struct update syntax)ä½¿ç”¨æ—§å®ä¾‹çš„å¤§éƒ¨åˆ†å€¼ç„¶ååªæ”¹å˜éƒ¨åˆ†å€¼æ¥åˆ›å»ºæ–°å®ä¾‹æ—¶ä½¿ç”¨ã€‚

å¦‚å·²ç»æœ‰ä¸€ä¸ª`user1`æ—¶ï¼Œä»¥ä¸‹ä¸¤ç§å†™æ³•ç›¸åŒï¼Œåè€…ä½¿ç”¨ç»“æ„ä½“æ›´æ–°è¯­æ³•

```rust
let user2 = User {
    active: user1.active,
    username: user1.username,
    email: String::from("another@example.com"),
    sign_in_count: user1.sign_in_count,
};
let user2 = User {
    email: String::from("another@example.com"),
    ..user1
};
```

ä½¿ç”¨ç»“æ„ä½“æ›´æ–°è¯­æ³•å°±åƒä½¿ç”¨`=`çš„èµ‹å€¼ï¼Œå› ä¸ºç§»åŠ¨äº†æ•°æ®ï¼Œè¿™é‡Œç”±äºç”¨äº†`String`çš„èµ‹å€¼ï¼Œä¼šå¯¼è‡´`user2`åˆ›å»ºå`user1`ä¸­çš„è¯¥éƒ¨åˆ†å¤±æ•ˆï¼Œä½†æ˜¯å¦‚æœè¿™é‡Œåªæ˜¯æ”¹äº†`u32`å’Œ`bool`ç±»å‹çš„å€¼æ—¶ï¼Œåˆ™ä»ç„¶æœ‰æ•ˆã€‚ä¸¤ç§å†™æ³•æœ¬è´¨ä¸€æ ·ï¼Œä½¿ç”¨æ›´æ–°è¯­æ³•èµ‹å€¼æœ¬è´¨æ˜¯å€¼çš„ç§»åŠ¨ï¼Œå‚è§ä¹‹å‰çš„å†…å®¹ï¼Œå¦‚æœè¯¥ç±»å‹å®ç°äº†`copy trait`å°±ä»å¯ä»¥åœ¨æ›´æ–°è¯­æ³•èµ‹å€¼åä½¿ç”¨ã€‚

#### ä½¿ç”¨æ²¡æœ‰å‘½åå­—æ®µçš„å…ƒç»„ç»“æ„ä½“æ¥åˆ›å»ºä¸åŒç±»å‹

å¯å®šä¹‰ä¸å…ƒç»„ç±»ä¼¼çš„ç»“æ„ä½“ï¼Œç§°ä¸ºå…ƒç»„ç»“æ„ä½“(tuple struct)ï¼Œæœ‰ç»“æ„ä½“æœ¬èº«åç§°å’Œå­—æ®µç±»å‹ï¼Œä½†æ˜¯æ²¡æœ‰å­—æ®µåï¼Œå¦‚

```rust
struct Color(i32, i32, i32);
struct Point(i32, i32, i32);

fn main() {
    let black = Color(0, 0, 0);
    let origin = Point(0, 0, 0);
}
```

è¿™é‡Œè™½ç„¶Colorå’ŒPointçš„æˆå‘˜ç±»å‹ç›¸åŒï¼Œä½†æ˜¯å±äºä¸åŒç±»å‹ã€‚

#### æ²¡æœ‰ä»»ä½•å­—æ®µçš„ç±»å•å…ƒç»“æ„ä½“

å®šä¹‰ä¸€ä¸ªæ— å­—æ®µçš„ç»“æ„ä½“ï¼Œç§°ä¸º**ç±»å•å…ƒç»“æ„ä½“(unit-like structs)**ï¼Œç±»ä¼¼äº**unitç±»å‹()**ï¼Œå¤šç”¨äºåé¢å®ç°`trait`æ—¶ï¼Œä¸€ä¸ªå®šä¹‰ä½¿ç”¨ä¾‹å­å¦‚ä¸‹

```rust
struct AlwaysEqual;
fn main() {
    let subject = AlwaysEqual;
}
```

#### ç»“æ„ä½“æ•°æ®çš„æ‰€æœ‰æƒ

æˆå‘˜ç”¨è‡ªèº«æ‹¥æœ‰æ‰€æœ‰æƒçš„ç±»å‹è€Œéå¼•ç”¨ï¼Œå¯ä»¥ä¿è¯åªè¦æ•´ä¸ªç»“æ„ä½“æœ‰æ•ˆåˆ™æ•°æ®éƒ½æœ‰æ•ˆï¼Œå¦‚æœä½¿ç”¨å¼•ç”¨ç±»å‹æ¥å®šä¹‰ï¼Œéœ€è¦åŠ ä¸Š**ç”Ÿå‘½å‘¨æœŸ(lifetime)**



### ç»“æ„ä½“ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹

```rust
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };

    println!(
        "The area of the rectangle is {} square pixels.",
        area(&rect1)
    );
}

fn area(rectangle: &Rectangle) -> u32 {
    rectangle.width * rectangle.height
}
```

`area`å‡½æ•°ä½¿ç”¨ç»“æ„ä½“çš„ä¸å¯å˜å€Ÿç”¨ï¼Œè¿™æ ·`main`ä¼šä¿æŒ`rect1`çš„æ‰€æœ‰æƒå¹¶ç»§ç»­ä½¿ç”¨ï¼Œæ‰€ä»¥å‡½æ•°ç­¾åç”¨äº†`&`

#### é€šè¿‡æ´¾ç”Ÿ`trait`å¢åŠ åŠŸèƒ½

##### ä½¿ç”¨printlnæ‰“å°è°ƒè¯•ä¿¡æ¯

å¦‚æœæƒ³è¦åœ¨è°ƒè¯•ç¨‹åºæ—¶æ‰“å°å‡ºæ‰€æœ‰ç»“æ„ä½“çš„å­—æ®µï¼Œå°è¯•ä½¿ç”¨`printfln!`å®

ç›´æ¥ä½¿ç”¨`println!("rect1 is {}", rect1);`ä¼šæŠ¥é”™

æç¤º`error[E0277]: Rectangle doesn't implement std::fmt::Display`

åŸå› æ˜¯è¿™é‡Œ`{}`ä¼šé»˜è®¤å‘Šè¯‰`println!`ä½¿ç”¨`Display`æ ¼å¼ï¼Œä½†æ˜¯å¯¹äºç»“æ„ä½“å› ä¸ºæ ¼å¼ä¸å›ºå®šï¼Œæ•…æ²¡æœ‰å®ç°`Display`å®ç°ã€‚

ä½†æ˜¯æŠ¥é”™ä¿¡æ¯ä¸­æœ‰æŒ‡æ˜ä¸€æ¡è·¯

`note: in format strings you may be able to use {:?} (or {:#?} for pretty-print) instead`

äºæ˜¯å°†è¾“å‡ºæ ¼å¼æ”¹æˆå¦‚ä¸‹å½¢å¼`println!("rect1 is {:?}", rect1)`

åœ¨`{}`ä¸­åŠ å…¥`:?`ä¼šå‘Šè¯‰`println!`ä½¿ç”¨`Debug`è¾“å‡ºæ ¼å¼ï¼Œåè€…æ˜¯ä¸€ä¸ª`trait`ï¼Œå…è®¸æ‰“å°ç»“æ„ä½“ï¼Œä»¥åœ¨è°ƒè¯•æ—¶çœ‹åˆ°ç»“æ„ä½“çš„å€¼ã€‚

ä½†æ­¤æ—¶ç›´æ¥ç¼–è¯‘ä»ä¼šæŠ¥é”™`error[E0277]: Rectangledoesn't implement Debug`

åŒæ ·ç»™å‡ºäº†æç¤ºä¿¡æ¯`note: add #[derive(Debug)] to Rectangle or manually impl Debug for Rectangle`

`Rust`ä¸­æœ‰å®ç°äº†æ‰“å°è°ƒè¯•ä¿¡æ¯åŠŸèƒ½ï¼Œä½†æ˜¯å¿…é¡»ä¸ºç»“æ„ä½“æ˜¾å¼é€‰æ‹©è¯¥åŠŸèƒ½ï¼Œä¸ºæ­¤åœ¨ç»“æ„ä½“å®šä¹‰ä¹‹å‰åŠ ä¸Šå±æ€§ `#[derive(Debug)]`

æœ€åå¾—åˆ°çš„ä»£ç å¦‚ä¸‹

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };

    println!("rect1 is {:?}", rect1);
}
```

æœ€åçš„æ ¼å¼æ§åˆ¶ä¹Ÿå¯ä»¥ä½¿ç”¨`{:#?}`è¿™æ ·ä¼šè®©ç»“æ„ä½“è¾“å‡ºç»“æœæ›´æ˜“è¯»

##### ä½¿ç”¨`dbg!`å®æ‰“å°è°ƒè¯•ä¿¡æ¯

è¯¥å®ä¼šæ¥æ”¶ä¸€ä¸ªè¡¨è¾¾å¼çš„æ‰€æœ‰æƒï¼Œæ‰“å°å‡ºä»£ç ä¸­è°ƒç”¨`dbg!`å®æ—¶æ‰€åœ¨çš„æ–‡ä»¶å’Œè¡Œå·ï¼Œè¡¨è¾¾å¼çš„ç»“æœï¼Œæœ€åè¿”å›è¯¥å€¼çš„æ‰€æœ‰æƒã€‚ä½†æ˜¯ä½¿ç”¨`dbg!`å®ä¼šæ‰“å°åˆ°æ ‡å‡†é”™è¯¯æ§åˆ¶å°æµ(`stderr`)ï¼Œç›¸å¯¹çš„`println!`ä¼šæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºæ§åˆ¶æµ(`stdout`)

ä¸‹é¢æ˜¯ä½¿ç”¨ä¾‹å­

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let scale = 2;
    let rect1 = Rectangle {
        width: dbg!(30 * scale),
        height: 50,
    };

    dbg!(&rect1);
}
```

è¿™é‡Œä½¿ç”¨`dbg!(30*scale)`æ—¶ç”±äºä¼šè¿”å›ä½¿ç”¨æƒï¼Œæ‰€ä»¥ç”¨èµ·æ¥å°±åƒæ²¡æœ‰ä½¿ç”¨è¯¥è°ƒç”¨ä¸€æ ·ã€‚ä¸‹é¢ä½¿ç”¨å¼•ç”¨ä»¥é¿å…`dbg!`æ‹¥æœ‰æ‰€æœ‰æƒã€‚

æœ€åå¾—åˆ°çš„è¾“å‡ºå¦‚ä¸‹

```bash
[src/main.rs:10] 30 * scale = 60
[src/main.rs:14] &rect1 = Rectangle {
    width: 60,
    height: 50,
}
```

é™¤äº†è¯¥`trait`ï¼Œ`rust`è¿˜æä¾›äº†å¾ˆå¤šé€šè¿‡`derive`å±æ€§æ¥ä½¿ç”¨çš„`trait`ï¼Œå…·ä½“åœ¨char10ä¼šåˆ†æã€‚



### æ–¹æ³•è¯­æ³•

ä¸å‡½æ•°ç±»ä¼¼ï¼Œä½¿ç”¨`fn`å…³é”®å­—ï¼Œæ‹¥æœ‰å‚æ•°å’Œè¿”å›å€¼ã€‚ä½†æ˜¯å…¶åœ¨ç»“æ„ä½“çš„ä¸Šä¸‹æ–‡ä¸­è¢«å®šä¹‰ï¼Œä¸”ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯`self`ï¼Œä»£è¡¨è°ƒç”¨è¯¥æ–¹æ³•çš„ç»“æ„ä½“ï¼ˆç±»ä¼¼`Python`ï¼‰

#### å®šä¹‰æ–¹æ³•

æŠŠä¹‹å‰çš„`area`æ”¹æˆ`Rectangle`ä¸­çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    fn area(&self) -> u32 {
        self.width * self.height
    }
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };

    println!(
        "The area of the rectangle is {} square pixels.",
        rect1.area()
    );
}
```

å…¶ä¸­`impl`æ˜¯`implementation`çš„ç¼©å†™ï¼Œæ ‡è®°è¯¥å—ä¸`Rectangle`ç±»å‹ç›¸å…³è”ï¼Œ`self`åœ¨è¿™é‡Œå°±ç›¸å½“äº`Rectangle`æ•…éœ€è¦å†åŠ ä¸€ä¸ª`&`è¡¨ç¤ºä½¿ç”¨çš„æ˜¯å¼•ç”¨ã€‚å¦‚æœæƒ³è¦æ”¹å˜ï¼Œä¸€èˆ¬æ¨èä½¿ç”¨å¯å˜å¼•ç”¨`&mut self`è€Œä¸æ˜¯ç›´æ¥è·å–æ‰€æœ‰æƒï¼Œåè€…é€šå¸¸ç”¨åœ¨å½“æ–¹æ³•æŠŠ`self`è½¬æ¢æˆåˆ«çš„å®ä¾‹çš„æƒ…å†µæ—¶ï¼Œç”¨æ¥é˜²æ­¢è°ƒç”¨è€…åœ¨è½¬æ¢åå†ä½¿ç”¨åŸæ¥çš„å®ä¾‹ã€‚

æ–¹æ³•ä¸æˆå‘˜å¯ä»¥åŒåï¼Œä½†é€šå¸¸ç”¨æ¥å®ç°è¿”å›ç‰¹å®šå­—æ®µçš„å€¼ç”¨ï¼Œç”¨æ¥å®ç°ç±»ä¼¼`CPP`ä¸­ç”¨`public`æ–¹æ³•æ‰“å°`private`æˆå‘˜çš„æ•ˆæœï¼Œè¿™æ ·çš„æ–¹æ³•ä¸€èˆ¬è¢«ç§°ä¸º`getters`

ä¸`CPP`ä¸­ä¸åŒï¼Œ`rust`é‡Œç”±äº`self`ä¼šåœ¨ä¸‰ç§æ ¼å¼ä¸­å›ºå®šé€‰æ‹©ï¼Œæ‰€ä»¥å®ç°äº†è‡ªåŠ¨è§£å¼•ç”¨ï¼Œä¸éœ€è¦å¯¹è±¡æœ¬èº«ç”¨`.`ï¼Œå¯¹è±¡çš„æŒ‡é’ˆç”¨`->`

#### å¸¦æœ‰æ›´å¤šå‚æ•°

å¢åŠ ä¸€ä¸ªéœ€è¦è·å–å¦ä¸€ä¸ª`Rectangle`å®ä¾‹ä½œä¸ºå‚æ•°çš„æ–¹æ³•`can_hold`ç”¨æ¥åˆ¤æ–­æœ¬é•¿æ–¹å½¢æ˜¯å¦èƒ½å®Œå…¨åŒ…å«å¦ä¸€ä¸ªé•¿æ–¹å½¢ã€‚

å¢åŠ åå¦‚ä¸‹

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    fn area(&self) -> u32 {
        self.width * self.height
    }

    fn can_hold(&self, other: &Rectangle) -> bool {
        self.width > other.width && self.height > other.height
    }
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };
    let rect2 = Rectangle {
        width: 10,
        height: 40,
    };
    let rect3 = Rectangle {
        width: 60,
        height: 45,
    };

    println!("Can rect1 hold rect2? {}", rect1.can_hold(&rect2));
    println!("Can rect1 hold rect3? {}", rect1.can_hold(&rect3));
}
```

#### å…³è”å‡½æ•°

æ‰€æœ‰åœ¨`impl`å—ä¸­å®šä¹‰çš„å‡½æ•°ç§°ä¸ºå…³è”å‡½æ•°(associated function)ï¼Œç”±äºå…¶å¯ä»¥ä¸ä»¥`self`ä¸ºç¬¬ä¸€å‚æ•°ï¼Œæ‰€ä»¥å…¶ä¹Ÿä¸æ˜¯æ–¹æ³•ï¼Œè°ƒç”¨ä½¿ç”¨`::`ï¼Œæ¯”å¦‚ `String::from`å°±æ˜¯åœ¨`String`ç±»å‹ä¸Šå®šä¹‰çš„å…³è”å‡½æ•°ã€‚

å…³è”å‡½æ•°å¸¸ç”¨æ¥ä½œä¸ºæŸäº›æ„é€ å‡½æ•°ï¼Œæ¯”å¦‚ä¼ ä¸€ä¸ªå‚æ•°ï¼Œæ„é€ æ­£æ–¹å½¢`Rectangle`

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    fn square(size: u32) -> Rectangle {
        Rectangle {
            width: size,
            height: size,
        }
    }
}

fn main() {
    let sq = Rectangle::square(3);
}
```

#### å¤šä¸ª`impl`å—

æ¯ä¸ªç»“æ„ä½“å…è®¸æœ‰å¤šä¸ª`impl`å—ï¼Œä¸å½±å“è¯­ä¹‰ï¼Œåœ¨æ³›å‹å’Œ`trait`ä¸­ä¼šæ¯”è¾ƒå®ç”¨
